<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AclCriteriaAndUpdateBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Acl for Spring Data MongoDB</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.acl.spring.data.mongodb</a> &gt; <span class="el_source">AclCriteriaAndUpdateBuilder.java</span></div><h1>AclCriteriaAndUpdateBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2022 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.acl.spring.data.mongodb;

import static org.springframework.core.annotation.AnnotationUtils.findAnnotation;
import static org.springframework.util.ObjectUtils.isEmpty;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;
import org.bremersee.acl.AccessEvaluation;
import org.bremersee.acl.Ace;
import org.bremersee.acl.Acl;
import org.bremersee.acl.AclUserContext;
import org.bremersee.acl.annotation.AclHolder;
import org.bremersee.acl.model.AccessControlEntryModifications;
import org.bremersee.acl.model.AccessControlListModifications;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Update;
import org.springframework.util.Assert;

/**
 * The acl criteria and update builder.
 *
 * @author Christian Bremer
 */
public class AclCriteriaAndUpdateBuilder {

  private final String aclPath;

  /**
   * Instantiates a new acl criteria and update builder.
   *
   * @param aclPath the acl path
   */
<span class="nc" id="L54">  public AclCriteriaAndUpdateBuilder(String aclPath) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">    this.aclPath = Objects.isNull(aclPath) ? &quot;&quot; : aclPath;</span>
<span class="nc" id="L56">  }</span>

  /**
   * Instantiates a new acl criteria and update builder.
   *
   * @param entityClass the entity class
   */
<span class="fc" id="L63">  public AclCriteriaAndUpdateBuilder(Class&lt;?&gt; entityClass) {</span>
<span class="fc" id="L64">    Assert.notNull(entityClass, &quot;Entity class must be present.&quot;);</span>
<span class="fc" id="L65">    this.aclPath = Optional</span>
<span class="fc" id="L66">        .ofNullable(findAnnotation(entityClass, AclHolder.class))</span>
<span class="fc" id="L67">        .map(AclHolder::path)</span>
<span class="pc" id="L68">        .orElseThrow(() -&gt; new IllegalArgumentException(String</span>
<span class="nc" id="L69">            .format(</span>
                &quot;Entity class %s must be annotated with %s.&quot;,
<span class="nc" id="L71">                entityClass.getSimpleName(), AclHolder.class.getSimpleName())));</span>
<span class="fc" id="L72">  }</span>

  /**
   * Build update acl modification update.
   *
   * @param accessControlListModifications the access control list modifications
   * @return the acl modification update
   */
  public AclModificationUpdate buildUpdate(
      AccessControlListModifications accessControlListModifications) {

<span class="pc bpc" id="L83" title="1 of 2 branches missed.">    Collection&lt;AccessControlEntryModifications&gt; mods = isEmpty(accessControlListModifications)</span>
<span class="nc" id="L84">        ? List.of()</span>
<span class="fc" id="L85">        : accessControlListModifications.getModificationsDistinct();</span>

<span class="fc" id="L87">    Update addAndSetUpdate = new Update();</span>
<span class="fc" id="L88">    Update removeUpdate = new Update();</span>
<span class="fc" id="L89">    boolean isSomethingRemoved = false;</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">    for (AccessControlEntryModifications mod : mods) {</span>

      // guest
<span class="fc" id="L94">      addAndSetUpdate = addAndSetUpdate.set(</span>
<span class="fc" id="L95">          path(Acl.ENTRIES, mod.getPermission(), Ace.GUEST),</span>
<span class="fc" id="L96">          mod.isGuest());</span>

      // users
<span class="fc bfc" id="L99" title="All 2 branches covered.">      if (!mod.getAddUsers().isEmpty()) {</span>
<span class="fc" id="L100">        addAndSetUpdate = addAndSetUpdate</span>
<span class="fc" id="L101">            .addToSet(path(Acl.ENTRIES, mod.getPermission(), Ace.USERS))</span>
<span class="fc" id="L102">            .each((Object[]) mod.getAddUsers().toArray(new String[0]));</span>
      }
<span class="fc bfc" id="L104" title="All 2 branches covered.">      if (!mod.getRemoveUsers().isEmpty()) {</span>
<span class="fc" id="L105">        isSomethingRemoved = true;</span>
<span class="fc" id="L106">        removeUpdate = removeUpdate.pullAll(</span>
<span class="fc" id="L107">            path(Acl.ENTRIES, mod.getPermission(), Ace.USERS),</span>
<span class="fc" id="L108">            mod.getRemoveUsers().toArray(new String[0]));</span>
      }

      // roles
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">      if (!mod.getAddRoles().isEmpty()) {</span>
<span class="nc" id="L113">        addAndSetUpdate = addAndSetUpdate</span>
<span class="nc" id="L114">            .addToSet(path(Acl.ENTRIES, mod.getPermission(), Ace.ROLES))</span>
<span class="nc" id="L115">            .each((Object[]) mod.getAddRoles().toArray(new String[0]));</span>
      }
<span class="fc bfc" id="L117" title="All 2 branches covered.">      if (!mod.getRemoveRoles().isEmpty()) {</span>
<span class="fc" id="L118">        isSomethingRemoved = true;</span>
<span class="fc" id="L119">        removeUpdate = removeUpdate.pullAll(</span>
<span class="fc" id="L120">            path(Acl.ENTRIES, mod.getPermission(), Ace.ROLES),</span>
<span class="fc" id="L121">            mod.getRemoveRoles().toArray(new String[0]));</span>
      }

<span class="fc bfc" id="L124" title="All 2 branches covered.">      if (!mod.getAddGroups().isEmpty()) {</span>
<span class="fc" id="L125">        addAndSetUpdate = addAndSetUpdate</span>
<span class="fc" id="L126">            .addToSet(path(Acl.ENTRIES, mod.getPermission(), Ace.GROUPS))</span>
<span class="fc" id="L127">            .each((Object[]) mod.getAddGroups().toArray(new String[0]));</span>
      }
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">      if (!mod.getRemoveGroups().isEmpty()) {</span>
<span class="nc" id="L130">        isSomethingRemoved = true;</span>
<span class="nc" id="L131">        removeUpdate = removeUpdate.pullAll(</span>
<span class="nc" id="L132">            path(Acl.ENTRIES, mod.getPermission(), Ace.GROUPS),</span>
<span class="nc" id="L133">            mod.getRemoveGroups().toArray(new String[0]));</span>
      }
<span class="fc" id="L135">    }</span>
<span class="fc" id="L136">    return AclModificationUpdate.builder()</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        .preparationUpdates(isSomethingRemoved ? List.of(addAndSetUpdate) : List.of())</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        .finalUpdate(isSomethingRemoved ? removeUpdate : addAndSetUpdate)</span>
<span class="fc" id="L139">        .build();</span>
  }

  /**
   * Build update.
   *
   * @param acl the acl
   * @return the update
   */
  public Update buildUpdate(Acl acl) {
<span class="fc bfc" id="L149" title="All 2 branches covered.">    return Update.update(path(), isEmpty(acl) ? Acl.builder().build() : acl);</span>
  }

  /**
   * Build update.
   *
   * @param newOwner the new owner
   * @return the update
   */
  public Update buildUpdate(String newOwner) {
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">    return Update.update(path(Acl.OWNER), isEmpty(newOwner) ? &quot;&quot; : newOwner);</span>
  }

  /**
   * Build update owner criteria.
   *
   * @param userContext the user context
   * @return the criteria
   */
  public Criteria buildUpdateOwnerCriteria(AclUserContext userContext) {
<span class="fc" id="L169">    Assert.notNull(userContext, &quot;User context must be present.&quot;);</span>
<span class="fc" id="L170">    return Criteria.where(path(Acl.OWNER)).is(userContext.getName());</span>
  }

  /**
   * Build permission criteria.
   *
   * @param userContext the user context
   * @param accessEvaluation the access evaluation
   * @param permissions the permissions
   * @return the criteria
   */
  public Criteria buildPermissionCriteria(
      AclUserContext userContext,
      AccessEvaluation accessEvaluation,
      Collection&lt;String&gt; permissions) {

<span class="fc" id="L186">    Assert.notNull(userContext, &quot;User context must be present.&quot;);</span>
<span class="fc" id="L187">    Assert.notNull(accessEvaluation, &quot;Access evaluation type must be present.&quot;);</span>
<span class="fc" id="L188">    Assert.notEmpty(permissions, &quot;At least one permission must be present.&quot;);</span>

<span class="fc" id="L190">    List&lt;Criteria&gt; permissionCriteriaList = Set.copyOf(permissions).stream()</span>
<span class="fc" id="L191">        .map(permission -&gt; createAccessCriteria(userContext, permission))</span>
<span class="fc" id="L192">        .collect(Collectors.toList());</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">    Criteria permissionCriteria = accessEvaluation.isAnyPermission()</span>
<span class="fc" id="L194">        ? new Criteria().orOperator(permissionCriteriaList)</span>
<span class="fc" id="L195">        : new Criteria().andOperator(permissionCriteriaList);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">    if (userContext.getName().isBlank()) {</span>
<span class="fc" id="L197">      return permissionCriteria;</span>
    }
<span class="fc" id="L199">    Criteria ownerCriteria = Criteria.where(path(Acl.OWNER)).is(userContext.getName());</span>
<span class="fc" id="L200">    return new Criteria().orOperator(ownerCriteria, permissionCriteria);</span>
  }

  private Criteria createAccessCriteria(
      AclUserContext userContext,
      String permission) {

<span class="fc" id="L207">    List&lt;Criteria&gt; criteriaList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L208">    criteriaList.add(Criteria.where(path(Acl.ENTRIES, permission, Ace.GUEST)).is(true));</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">    if (!userContext.getName().isBlank()) {</span>
<span class="fc" id="L210">      criteriaList.add(Criteria</span>
<span class="fc" id="L211">          .where(path(Acl.ENTRIES, permission, Ace.USERS))</span>
<span class="fc" id="L212">          .all(userContext.getName()));</span>
    }
<span class="fc" id="L214">    criteriaList.addAll(userContext.getRoles().stream()</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        .filter(role -&gt; !isEmpty(role))</span>
<span class="fc" id="L216">        .map(role -&gt; Criteria.</span>
<span class="fc" id="L217">            where(path(Acl.ENTRIES, permission, Ace.ROLES))</span>
<span class="fc" id="L218">            .all(role))</span>
<span class="fc" id="L219">        .toList()</span>
    );
<span class="fc" id="L221">    criteriaList.addAll(userContext.getGroups().stream()</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        .filter(group -&gt; !isEmpty(group))</span>
<span class="fc" id="L223">        .map(group -&gt; Criteria</span>
<span class="fc" id="L224">            .where(path(Acl.ENTRIES, permission, Ace.GROUPS))</span>
<span class="fc" id="L225">            .all(group))</span>
<span class="fc" id="L226">        .toList()</span>
    );
<span class="fc" id="L228">    return new Criteria().orOperator(criteriaList);</span>
  }

  private String path(String... pathSegments) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">    if (isEmpty(pathSegments)) {</span>
<span class="fc" id="L233">      return aclPath;</span>
    }
<span class="fc" id="L235">    return aclPath + &quot;.&quot; + String.join(&quot;.&quot;, pathSegments);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>